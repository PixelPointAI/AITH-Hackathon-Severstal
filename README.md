# Алгоритм для Высокоточных 3D Измерений

## Обзор

Этот проект разработан в рамках хакатона для создания высокоточного алгоритма измерения расстояний между маркерными точками на объектах, изображенных на парных фотографиях. Основная цель проекта — разработать эффективный и точный метод определения реальных расстояний с использованием методов компьютерного зрения (CV).

## Основные Особенности

- **Высокая Точность:** Алгоритм обеспечивает точность измерений в пределах погрешности 0,1 мм.
- **Быстрое Выполнение:** Время выполнения измерения составляет менее 1 секунды от ввода изображения до получения результата.

## Начало Работы

### Необходимые Условия

- Python 3.10

### Установка Пакета

pip install .
pip install git+https://github.com/cvg/LightGlue.git@main

### Гененрация синтетических изображений

Для генерации изображений для обучения модели используется графический редактор Blender, в котором присутствует возможность задавать собственные скрипты для создания и рендера сцены.

Установка Blender:

```bash
wget https://download.blender.org/release/Blender3.6/blender-3.6.0-linux-x64.tar.xz
tar -xvf blender-3.6.0-linux-x64.tar.xz
rm blender-3.6.0-linux-x64.tar.xz
```

Скрипт для генерации изображений лежит по пути `scripts/render.sh`. В нем необходимо указать путь до объекта для рендера и директорию, куда сохранить сгенерированные изображения.

После запуска скрипта должна получится следующая структура:

```
- save_dir
    - pair_0
        - image_left.png
        - image_right.png
    - pair_1
        - image_left.png
        - image_right.png
    ...
```

где в папках `pair_*` лежат сгенерированные пары изображений с рандомными поворотами по оси Z.

## Подсчет расстояний на синтетических данных

**Ссылка на Интерфейс в Google Collab: https://colab.research.google.com/drive/1m_N_agT3jzgnxFM-_Rfe5rKSiyjdEoJH?usp=sharing**

Для подсчета расстояний на синтетических данных сначала необходимо откалибровать камеру. Далее строится облако точек в котором находятся нужные нам точки, отмеченные пользователем, или найденные с помощью NN/CV по паттерну. В конечном итоге расстояние считается как норма вектора между двумя точками в Евклидовом пространстве.

### Калибровка камеры на синтетических данных

После калибровки камеры получаем несколько параметров:

```
"CM" - Camera intrinsic matrix.
"E" - Output essential matrix.
"F" - Output fundamental matrix.
"R" - Output rotation matrix between the 1st and the 2nd camera coordinate systems.
"T" - Output translation vector between the coordinate systems of the cameras.
"dist" - Output vector of distortion coefficients.
```

Калибровка ведется с использованием шахматной доски:

<img width="200" heigth="200" alt="image" src="https://github.com/user-attachments/assets/33212fd1-8e82-45c0-bbc4-dea33a18d3ee">

### Подсчет диспаритета и карты глубины

Подсчет диспаритета осуществляется с помощью функции `StereoBM_create`
Для подсчета карты глубины используется ректификация, позволяющая посчитать матрицу отображения диспаритета в глубину
Нахождение эпиполярных линий также ускоряет подсчет карты глубины

Диспаритет представлен в виде изображения в ЧБ:
<img width="1263" alt="image" src="https://github.com/user-attachments/assets/1e0817e4-a242-4f89-9399-e41ad810376f">

### Построение облака точек из парных изображений. Перепроецирование в 3D пространство

C помощью построенной карты диспаритета и глубины вычисляется облако точек.
С помощью только лишь двух фотографий можно определить примерные очертания 3D модели по двум сторонам,
но никак не по всему периметру, поэтому при генерации 3D облака точек, оно представляет собой пирамидальную структуру.
Это не полноценная 3D модель, но её аналог.

После построения облака точек можно посмотреть различные его 2D-проекции под разными углами:
<img width="500" alt="image" src="https://github.com/user-attachments/assets/d8f95a7e-f4fa-4e3b-9a1a-fa610990f53f">

### Выделение нужных точек, и подсчет расстояния между ними

Сейчас реализован функционал, с помощью которого можно отметить прямо в jupyter-ноутбуке две любые точки на изображении, и посчитать между ними расстояние в 3D
В качестве интерфейса взаимодействия используется jupyter notebook в Google Collab.
<img width="500" alt="image" src="https://github.com/user-attachments/assets/a8ba0dc4-8b48-4d51-a50f-0e78f4d40b2a">
