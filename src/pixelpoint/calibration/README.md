# Модуль калибровки стереокамеры

Этот модуль предоставляет инструменты для **калибровки стереокамеры**, что является важной частью при работе со стерео-зрением. Процесс калибровки вычисляет как **внутренние**, так и **внешние** параметры системы стереокамеры. Модуль поддерживает три метода калибровки:

1. **Калибровка с использованием маркерных точек** (calibration_markers.py)
1. **Калибровка с использованием шахматной доски** (calibration_chessboard.py)
1. **Калибровка с помощью прямого матричного расчета** (calibration_calculation.py)

## Структура модуля

```
calibration
├── __init__.py
├── calibration_markers.py
├── calibration_chessboard.py
├── calibration_calculation.py
├── calibration_utils.py
└── README.md
```

## Зависимости

Все необходимые зависимости и инструкции по сборке определены в файле pyproject.toml, который находится в корне репозитория. Способ установки описан в [Установка](../../../README.md#%D1%83%D1%81%D1%82%D0%B0%D0%BD%D0%BE%D0%B2%D0%BA%D0%B0-%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B0).

## Реализованные методы калибровки

### 1. **calibration_markers.py**

Этот метод выполняет калибровку стереокамеры с использованием парных изображений с сеткой точек маркеров.

#### Принцип работы:

1. Скрипт загружает изображения с обоих камер с ожидаемыми префиксами для имен файлов — `cam1_` для первой камеры и `cam2_` для второй.
1. Загрузка координат маркеров из JSON-файла, указанных в формате `"x1,y1", "x2,y2", ...`.
1. Выполняется калибровка каждой камеры по отдельности на основе маркеров. Это выполняется с помощью **`cv.calibrateCamera`**
1. Проводится стереокалибровка двух камер через **`cv.stereoCalibrate`**, используя данные маркеров, чтобы рассчитать параметры камеры (матрицу камеры, коэффициенты искажения, ротацию, трансляцию и др.).
1. Результаты калибровки сохраняются в JSON-файл.

#### Аргументы:

1. `--images_folder`: Путь к папке с изображениями для калибровки (по умолчанию: `notebooks/calibration/calibration_images_markers`).
1. `--markers_file`: Путь к JSON-файлу с координатами маркеров.
1. `--marker_distance`: Расстояние между маркерами (в метрах).
1. `--grid_size`: Размер сетки маркеров (например, "7x7").
1. `--output_file`: Путь к файлу для сохранения параметров калибровки (по умолчанию: `calib_params.json`)

```bash
python calibration_markers.py --images_folder <путь к папке с изображениями> --markers_file <путь к файлу с маркерами> --marker_distance <расстояние между маркерами> --grid_size <размер сетки маркеров> --output_file <путь для сохранения параметров>
```

**Пример запуска**:

```bash
python calibration_markers.py --images_folder ./images --markers_file ./markers.json --marker_distance 0.012 --grid_size 7x7 --output_file calibration_params.json
```

### 2. **calibration_chessboard.py**

Этот метод использует традиционный шаблон шахматной доски для калибровки. Пользователь предоставляет парные изображения с видимой шахматной доской, а модуль автоматически определяет углы для выполнения стереокалибровки.

#### Принцип работы:

1. Загрузка изображений камер
1. Поиск углов шахматной доски, используется методы `findChessboardCorners` и `cornerSubPix` из OpenCV
1. Поиск внутренних, внешних параметров стерео-камеры
1. Сохранение результатов в JSON

#### Аргументы:

1. `--images_folder`: Путь к папке с изображениями для калибровки (по умолчанию: `notebooks/calibration/calibration_images_chessboard`).
1. `--square_size`: Размер квадратов на шахматной доске в метрах (по умолчанию: 0.01 м).
1. `--chessboard_size`: Размер шахматной доски (например, "7x7").
1. `--output_file`: Путь для сохранения параметров калибровки (по умолчанию: `calib_params.json`).

```bash
python calibration_chessboard.py --images_folder <путь к папке с изображениями> --square_size <размер квадрата> --chessboard_size <размер шахматной доски> --output_file <путь для сохранения параметров>
```

**Пример запуска**:

```bash
python calibration_chessboard.py --images_folder ./chessboard_images --square_size 0.01 --chessboard_size 7x7 --output_file calibration_params.json
```

### 3. **calibration_calculation.py**

Этот метод вычисляет матрицы камеры напрямую, используя оптические свойства камеры (фокусное расстояние, размер пикселя и т. д.) и геометрическую конфигурацию стереоустановки. Он не требует входных данных изображения, но полагается на известные параметры стереосистемы, такие как базовая линия и фокусное расстояние.

#### Принцип работы:

1. **Ввод параметров**: Пользователь задает ключевые параметры камеры, такие как фокусное расстояние, разрешение изображения, размеры пикселя, расстояние между камерами и расстояние до объекта.
1. **Расчеты матриц**: Скрипт вычисляет матрицы CM, R, T, F, E.
1. **Сохранение параметров**: Результаты сохраняются в JSON-файл с помощью функции `save_calibration_params`.

### Аргументы скрипта:

1. `--focal-length`: Фокусное расстояние в метрах (по умолчанию: 0.08 м).
1. `--resolution`: Разрешение изображения в формате `ширинаxвысота` (по умолчанию: 5120x4096).
1. `--pixel-size`: Размер пикселя по осям `x` и `y` в метрах (по умолчанию: 4.5e-6 м).
1. `--baseline`: Расстояние между камерами в метрах (по умолчанию: 0.412 м).
1. `--cam2obj`: Расстояние от камеры до объекта в метрах (по умолчанию: 0.65 м).
1. `--output_file`: Путь для сохранения параметров калибровки (по умолчанию: `calib_params.json`).

```bash
python calibration_calculation.py --focal-length <фокусное расстояние> --resolution <разрешение изображения> --pixel-size <размер пикселя> --baseline <расстояние между камерами> --cam2obj <расстояние до объекта> --output_file <путь для сохранения параметров>
```

**Пример запуска**:

```bash
python calibration_calculation.py --focal-length 0.08 --resolution 5120x4096 --pixel-size 4.5e-6,4.5e-6 --baseline 0.412 --cam2obj 0.65 --output_file calibration_params.json
```

## Выходные данные

Каждый метод возвращает файл JSON со следующими параметрами калибровки:

- **Матрица камеры (CM)**: описывает внутренние параметры (фокусное расстояние, центральная точка и т. д.).
- **Коэффициенты искажения (dist)**: описывают искажения объектива (тангенциальное и радальное).
- **Матрица вращения (R)**: относительное вращение между системами координат первой и второй камер.
- **Вектор смещения (T)**: относительное смещение между двумя камерами.
- **Основная матрица (E)**: кодирует относительное вращение и перемещение, определяя эпиполярную геометрию.
- **Фундаментальная матрица (F)**: определяет эпиполярные линии, связывая соответствующие точки на двух изображениях.

```json
{
"camera_matrix": [[...], [...], [...]],
"distortion_coefficients": [...],
"rotation_matrix": [[...], [...], [...]],
"translation_vector": [...],
"essential_matrix": [[...], [...], [...]],
"fundamental_matrix": [[...], [...], [...]]
}
```

## Пайплайны для калибровки стерео-камер

1. [Jupyter блокнот](../../../notebooks/calibration/calibration_real.ipynb) с пайплайном для калибровки стерео-камеры на основе реальных калибровочных изображений с маркерными досками
1. [Jupyter блокнот](../../../notebooks/calibration/calibration_synthetic.ipynb)  с пайплоном для калибровки стерео-камеры на основе синтетических калибровочных изображений с шахматными досками
